name: build-images action template
permissions: {}

on:
  workflow_call:
    inputs:
      ref:
        required: false
        description: "Git reference of the workflow's trigger"
        type: string
      image-build-args:
        required: false
        description: "Arguments to pass to the image build process"
        type: string
      image-name:
        required: true
        description: "Name of the image to build"
        type: string
      image-tag:
        required: false
        description: "Override autogenerated image tag"
        type: string
        default: ""
      dockerfile-directory:
        required: false
        description: "The directory where the dockerfile locates, as relative to the repo root"
        type: string
        default: .
      pushImage:
        required: false
        description: "Whether to push the image afterwards"
        type: boolean
        default: true
      multiPlatform:
        required: false
        description: "Enable multiPlatform builds for the container image"
        type: boolean
        default: false
      platform:
        required: false
        description: "Architecture platforms for the image build (linux/amd64,linux/arm64, etc.)"
        type: string
        default: ""
      artifact-name:
        required: false
        description: "Name of an artifact to be downloaded. Setting this will set the downloaded artifact direcory as image building base."
        type: string
        default: ""
    secrets:
      QUAY_USERNAME:
        required: true
      QUAY_PASSWORD:
        required: true
      SLACK_WEBHOOK:
        required: true

jobs:
  job:
    runs-on: ubuntu-latest
    if: github.repository_owner == 'metal3-io'

    permissions:
      contents: read

    steps:
    - name: Set GITHUB_REF and GITHUB_REFNAME to the inputs' ref, or default to github's ref
      id: set_ref
      run: |
        REF="${{ inputs.ref || github.ref }}"
        echo "Using INPUT REF: ${REF}"
        REF_NAME="${REF#refs/heads/}"
        REF_NAME="${REF_NAME#refs/tags/}"
        echo "GITHUB_REF=${REF}" >> "${GITHUB_ENV}"
        echo "GITHUB_REFNAME=${REF_NAME}" >> "${GITHUB_ENV}"
        echo "Using GITHUB REFNAME: ${REF_NAME}"

    - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
      with:
        ref: ${{ env.GITHUB_REF }}

    - name: Set GITHUB_REFSHA to sha of the ref
      id: set_refsha
      run: |
        REF_SHA=$(git rev-parse HEAD)
        echo "GITHUB_REFSHA=${REF_SHA}" >> "${GITHUB_ENV}"

    - name: Get current date
      id: date
      run: echo "current_date=$(date +'%Y-%m-%d')" >> "${GITHUB_OUTPUT}"

    - name: Get image tags and set version label
      id: image_tags
      run: |
        BASE_TAG=$(echo "${{ env.GITHUB_REFNAME }}" | sed 's/\//_/')
        IMAGE_TAGS="${BASE_TAG}, ${BASE_TAG}_${{ steps.date.outputs.current_date }}_${{ env.GITHUB_REFSHA }}"

        if [[ -n "${{ inputs.image-tag }}" ]]; then
          IMAGE_TAGS="${{ inputs.image-tag }}"
          IMAGE_VERSION="${{ inputs.image-tag }}"
        elif [[ "${{ env.GITHUB_REF }}" == "refs/heads/main" ]]; then
          IMAGE_TAGS="${IMAGE_TAGS}, latest"
          IMAGE_VERSION="latest"
        else
          IMAGE_VERSION="${{ env.GITHUB_REFNAME }}"
        fi

        echo "IMAGE_TAGS=${IMAGE_TAGS}" >> "${GITHUB_ENV}"
        echo "IMAGE_VERSION=${IMAGE_VERSION}" >> "${GITHUB_ENV}"

    - name: Download artifact
      id: download-artifact
      if: ${{ inputs.artifact-name }} != ""
      uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0.0
      with:
        name: ${{ inputs.artifact-name }}
        path: /tmp/build-${{ inputs.image-name }}

    - name: Build ${{ inputs.image-name }} image
      uses: mr-smithers-excellent/docker-build-push@19d2beefef6bcdc202195fdcb9deb79a4fab5c1f # v6.8
      with:
        image: metal3-io/${{ inputs.image-name }}
        tags: ${{ env.IMAGE_TAGS }}
        directory: ${{ steps.download-artifact.outputs.download-path || inputs.dockerfile-directory }}
        dockerfile: ${{ steps.download-artifact.outputs.download-path || inputs.dockerfile-directory }}/Dockerfile
        buildArgs: ${{ inputs.image-build-args || '' }}
        labels: |
          org.opencontainers.image.version=${{ env.IMAGE_VERSION }}
        registry: quay.io
        username: ${{ secrets.QUAY_USERNAME }}
        password: ${{ secrets.QUAY_PASSWORD }}
        pushImage: ${{ inputs.pushImage }}
        multiPlatform: ${{ inputs.multiPlatform }}
        platform: ${{ inputs.platform }}

    - name: Slack Notification on Failure
      if: ${{ failure() }}
      uses: rtCamp/action-slack-notify@e31e87e03dd19038e411e38ae27cbad084a90661 # 2.3.3
      env:
        SLACK_TITLE: "GitHub Action Failed in ${{ github.repository }}"
        SLACK_COLOR: "#FF0000"
        SLACK_MESSAGE: "The GitHub Action workflow failed for ${{ inputs.image-name }} image build."
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        SLACK_CHANNEL: metal3-github-actions-notify
        SLACK_USERNAME: metal3-github-actions-notify
